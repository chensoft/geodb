use std::sync::LazyLock;

use serde::{Serialize, Deserialize};
use anyhow::Result;
use indexmap::IndexMap;
use handlebars::Handlebars;

#[derive(Debug, Default, Clone, Serialize, Deserialize)]
#[serde(default)]
pub struct Country {
    /// e.g., "US"
    pub alpha2: String,

    /// e.g., "USA"
    pub alpha3: String,

    /// e.g., 840
    pub numeric: i32,
}

pub static COUNTRIES: LazyLock<IndexMap<String, Country>> = LazyLock::new(|| {
    let mut csv = csv::Reader::from_path("datasets/country.csv").expect("missing country file");
    let mut map = IndexMap::new();

    for val in csv.deserialize() {
        let val: Country = val.expect("parse country failed");
        map.insert(val.alpha2.clone(), val);
    }

    map
});

pub fn generate() -> Result<()> {
    let countries: Vec<Country> = COUNTRIES.values().cloned().collect();

    let mut template = Handlebars::new();
    template.register_template_string("default", r#"// !!!DO NOT EDIT THIS FILE!!! //

/// Country
#[derive(Debug, Clone, Copy, Hash, Eq, PartialEq, Ord, PartialOrd, Serialize, Deserialize)]
pub enum Country {
{{#each countries}}
    {{this.alpha2}},
{{/each}}
}

impl Country {
    /// ISO 3166-1 alpha2 code
    pub fn alpha2(&self) -> &str {
        match self {
{{#each countries}}
            Self::{{this.alpha2}} => "{{this.alpha2}}",
{{/each}}
        }
    }

    /// ISO 3166-1 alpha3 code
    pub fn alpha3(&self) -> &str {
        match self {
{{#each countries}}
            Self::{{this.alpha2}} => "{{this.alpha3}}",
{{/each}}
        }
    }

    /// ISO 3166-1 numeric code
    pub fn numeric(&self) -> i32 {
        match self {
{{#each countries}}
            Self::{{this.alpha2}} => {{this.numeric}},
{{/each}}
        }
    }
}"#)?;

    std::fs::write("src/country.rs", template.render("default", &indexmap! { "countries" => countries})?)?;

    Ok(())
}